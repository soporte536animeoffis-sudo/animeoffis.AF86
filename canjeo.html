<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Verificaci√≥n por C√≥digo</title>

  <style>
    body {
      background-color: #0b0b0c;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 50px;
    }

    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }

    #insignias-container {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .insignia {
      text-align: center;
      margin: 10px;
    }

    .insignia img {
      width: 50px;
      display: block;
      margin: 0 auto 5px;
    }
  </style>
</head>
<body>

<h1>Ingresa tu c√≥digo de regalo</h1>

<input type="text" id="code-input" placeholder="C√≥digo">
<button id="verify-btn">Verificar</button>

<div id="insignias-container"></div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // üî• Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAu0WbdAi8_yA2S6qKMUCLfty5w0PxgKVE",
    authDomain: "anime-offis.firebaseapp.com",
    projectId: "anime-offis",
    storageBucket: "anime-offis.appspot.com",
    messagingSenderId: "377121993034",
    appId: "1:377121993034:web:a4ba7995e827bcbea411b3"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  // üèÖ Insignias
  const insigniasMap = {
    creador: { src: "crea.png", text: "Creador ‚ùÑÔ∏è" },
    beta: { src: "beta.png", text: "Usuario Beta ‚öôÔ∏è" },
    platinum: { src: "plat.png", text: "Platinum üëë" },
    imperial: { src: "imperial.png", text: "Imperial üèÜ" },
    colaborador: { src: "cola.png", text: "Colaborador ü§ù" },
    aportador: { src: "aportador.png", text: "Aportador ‚ö°" },
    soporte: { src: "soport.png", text: "Soporte ‚úÖ" },
    dora: { src: "verif.png", text: "Verificado Premium ‚úÖ" },
    azul: { src: "azul.png", text: "Fan Anime Offis ‚úÖ" },
    verde: { src: "verde.png", text: "Fan B√°sico ‚úÖ" },
    estre: { src: "estre.png", text: "Comprador Estrella üåü" }
  };

  const codeInput = document.getElementById("code-input");
  const verifyBtn = document.getElementById("verify-btn");
  const insigniasContainer = document.getElementById("insignias-container");

  let currentUserId = null;

  // üë§ Detectar sesi√≥n
  auth.onAuthStateChanged(async user => {
    if (!user) {
      alert("Debes iniciar sesi√≥n para usar esta funci√≥n.");
      return;
    }

    currentUserId = user.uid;
    const userRef = db.collection("users").doc(currentUserId);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      await userRef.set({ verified: [] });
      renderInsignias([]);
      return;
    }

    const verifications = userDoc.data().verified || [];
    renderInsignias(verifications);
  });

  // ‚úÖ Verificar c√≥digo
  verifyBtn.addEventListener("click", async () => {
    if (!currentUserId) {
      alert("Usuario no autenticado.");
      return;
    }

    const code = codeInput.value.trim().toUpperCase();
    if (!code) return alert("Ingresa un c√≥digo");

    const codeRef = db.collection("codes").doc(code);
    const codeDoc = await codeRef.get();

    if (!codeDoc.exists) {
      alert("C√≥digo inv√°lido o no registrado.");
      return;
    }

    const { tipo } = codeDoc.data();
    if (!tipo) {
      alert("Este c√≥digo no tiene tipo definido.");
      return;
    }

    const userRef = db.collection("users").doc(currentUserId);
    const userDoc = await userRef.get();
    const verifications = userDoc.data().verified || [];

    if (verifications.includes(tipo)) {
      alert("Ya tienes esta verificaci√≥n.");
      return;
    }

    // üî• AQU√ç ESTABA EL ERROR ‚Üí ahora s√≠ se agrega
    verifications.push(tipo);

    await userRef.set({ verified: verifications }, { merge: true });

    renderInsignias(verifications);

    alert(`¬°C√≥digo v√°lido! Se te asign√≥: ${insigniasMap[tipo]?.text || tipo}`);
    codeInput.value = "";
  });

  // üé® Mostrar insignias
  function renderInsignias(verifications) {
    insigniasContainer.innerHTML = "";

    verifications.forEach(tipo => {
      const info = insigniasMap[tipo.toLowerCase()];
      if (!info) return;

      const div = document.createElement("div");
      div.className = "insignia";

      const img = document.createElement("img");
      img.src = info.src;
      img.alt = info.text;

      const label = document.createElement("div");
      label.textContent = info.text;

      div.appendChild(img);
      div.appendChild(label);
      insigniasContainer.appendChild(div);
    });
  }
</script>

</body>
</html>